#####################################################################
# --- Swingarm Stepper with Sensorless Homing (Discrete Open/Close) -
#####################################################################

[tmc2209 swingarm]
uart_pin: PC4                 # adjust to your wiring
uart_address: 0                # set per your board
run_current: 0.55              # tune to your motor
sense_resistor: 0.110
# Do not set hold_current while tuning
stealthchop_threshold: 0       # StallGuard needs spreadCycle
diag_pin: ^PG12                # DIAG pin wired to MCU
driver_SGTHRS: 255             # start max sensitive, tune down

[stepper swingarm]
step_pin: PE2
dir_pin: PC5
enable_pin: !PF11
microsteps: 16
rotation_distance: 90          # 1 "mm" = 90째
position_min: 0
position_max: 90
endstop_pin: tmc2209_swingarm:virtual_endstop
homing_speed: 35               # ~1 rev in ~2s, adjust as needed
homing_positive_dir: false     # move toward closed stop
homing_retract_dist: 0         # no second pass


#####################################################################
# --- Swingarm Macros ---
#####################################################################

[gcode_macro HOME_SWINGARM]
description: "Sensorless home swingarm to 0째 (closed)"
gcode:
  G4 P500                   # wait to clear any stale stall state
  G28 SWINGARM
  G1 SWINGARM=5 F1200       # back off slightly to relieve pressure

[gcode_macro SWINGARM_OPEN]
description: "Move swingarm to 90째 (open)"
gcode:
  G1 SWINGARM=90 F2000

[gcode_macro SWINGARM_CLOSE]
description: "Move swingarm to 0째 (closed)"
gcode:
  G1 SWINGARM=0 F2000

#####################################################################
# --- Tuning Helpers ---
#####################################################################

[gcode_macro SET_SWINGARM_SGTHRS]
description: "Set SGTHRS sensitivity for swingarm driver"
gcode:
  {% set v = params.VALUE|int %}
  SET_TMC_FIELD STEPPER=stepper_swingarm FIELD=SGTHRS VALUE={v}
  RESPOND PREFIX="SGTHRS" MSG="swingarm SGTHRS={v}"

[gcode_macro SET_SWINGARM_CURRENT]
description: "Set TMC run current for swingarm stepper"
gcode:
  {% set c = params.CURRENT|float %}
  SET_TMC_CURRENT STEPPER=stepper_swingarm CURRENT={c}
  RESPOND PREFIX="TMC" MSG="swingarm run_current={c}A"

[gcode_macro TUNE_SWINGARM_HOMING]
description: "Try homing swingarm with given SGTHRS and optional CURRENT"
gcode:
  {% if 'CURRENT' in params %}
    SET_SWINGARM_CURRENT CURRENT={params.CURRENT}
    G4 P200
  {% endif %}
  SET_SWINGARM_SGTHRS VALUE={params.SGTHRS|int}
  G4 P200
  G28 SWINGARM
  G1 SWINGARM=5 F1200
  DUMP_TMC STEPPER=stepper_swingarm
