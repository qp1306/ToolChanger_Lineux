#####################################################################
# Swingarm Stepper (sensorless homing using real axis)
#####################################################################

[stepper_b]
step_pin: PE2
dir_pin: !PC5                     # flip if needed
enable_pin: !PF11
microsteps: 16
rotation_distance: 360            # degrees per full rotation
position_endstop: 0               # logical home at 0deg
position_min: 0
position_max: 120                 # safe max swing angle
homing_speed: 80                  # deg/sec
homing_retract_dist: 0            # no retract for swinging
endstop_pin: tmc2209_stepper_b:virtual_endstop   # use DIAG for stall detect

[tmc2209 stepper_b]
uart_pin: PC4
run_current: 0.10
hold_current: 0.10
sense_resistor: 0.110
diag_pin: PG12
driver_SGTHRS: 5                  # stall sensitivity
stealthchop_threshold: 0          # disable during homing for better StallGuard
interpolate: True

#####################################################################
# Swingarm Macros
#####################################################################

[gcode_macro SWINGARM_HOME]
description: "Home swingarm using sensorless StallGuard"
gcode:
  RESPOND PREFIX="SWINGARM" MSG="Starting sensorless homing..."
  G28 B                               # home only the swingarm (B axis)

[gcode_macro SWINGARM_ZERO]
description: "Manually set swingarm to 0°"
gcode:
  SET_KINEMATIC_POSITION B=0
  RESPOND PREFIX="SWINGARM" MSG="Position reset manually to 0°"

[gcode_macro SWINGARM_OPEN]
description: "Move swingarm to ~90° (open)"
gcode:
  G1 B=98 F3000                       # Position B to approx 90°

[gcode_macro SWINGARM_CLOSE]
description: "Move swingarm to 0° (closed)"
gcode:
  G1 B=0 F3000


[gcode_macro SWINGARM_TOGGLE]
description: "Toggle swingarm open/close"
variable_state: 0
gcode:
  {% if printer["gcode_macro SWINGARM_TOGGLE"].state|int == 0 %}
    SWINGARM_OPEN
    SET_GCODE_VARIABLE MACRO=SWINGARM_TOGGLE VARIABLE=state VALUE=1
  {% else %}
    SWINGARM_CLOSE
    SET_GCODE_VARIABLE MACRO=SWINGARM_TOGGLE VARIABLE=state VALUE=0
  {% endif %}
