#####################################################################
# Swingarm Stepper (now a real axis, with sensorless homing)
#####################################################################

[stepper_swingarm]
step_pin: PE2
dir_pin: !PC5                     # invert if needed
enable_pin: !PF11
microsteps: 16
rotation_distance: 360            # 360° per full rotation
endstop_pin: tmc2209_stepper_swingarm:virtual_endstop   # enable StallGuard as endstop
position_endstop: 0               # logical home position
position_min: 0
position_max: 120                 # safety limit to avoid full rotations
homing_speed: 80                  # deg/sec homing speed
homing_retract_dist: 0            # no retract for rotational axis
homing_direction: -1              # home toward decreasing position

[tmc2209 stepper_swingarm]
uart_pin: PC4
run_current: 0.10                 # light current for low-load swingarm
hold_current: 0.10
sense_resistor: 0.110
stealthchop_threshold: 0          # disable stealthChop for reliable StallGuard during homing
interpolate: true
diag_pin: PG12                    # DIAG pin triggers sensorless endstop
driver_SGTHRS: 5                  # sensitivity (tune if needed)


#####################################################################
# Swingarm Control Macros
#####################################################################

[gcode_macro SWINGARM_HOME]
description: "Home swingarm using StallGuard stall-detection"
gcode:
  RESPOND PREFIX="SWINGARM" MSG="Homing swingarm..."
  G28 S                                        # home only the swingarm

[gcode_macro SWINGARM_ZERO]
description: "Manually reset swingarm to 0°"
gcode:
  SET_KINEMATIC_POSITION SWINGARM=0
  RESPOND PREFIX="SWINGARM" MSG="Position reset to 0°"

[gcode_macro SWINGARM_OPEN]
description: "Move swingarm to 90° (open)"
gcode:
  G1 SWINGARM=98 F3000                         # move to approx. open angle

[gcode_macro SWINGARM_CLOSE]
description: "Move swingarm to 0° (closed)"
gcode:
  G1 SWINGARM=0 F3000                          # return to closed position


[gcode_macro SWINGARM_TOGGLE]
description: "Toggle swingarm OPEN/CLOSE"
variable_state: 0
gcode:
  {% if printer["gcode_macro SWINGARM_TOGGLE"].state|int == 0 %}
    SWINGARM_OPEN
    SET_GCODE_VARIABLE MACRO=SWINGARM_TOGGLE VARIABLE=state VALUE=1
  {% else %}
    SWINGARM_CLOSE
    SET_GCODE_VARIABLE MACRO=SWINGARM_TOGGLE VARIABLE=state VALUE=0
  {% endif %}
