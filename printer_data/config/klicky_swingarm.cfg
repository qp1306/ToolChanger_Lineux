#####################################################################
# Swingarm: smoother sensorless homing (no buzzing at the stop)
#####################################################################

[manual_stepper swingarm]
step_pin: PE2
dir_pin: !PC5
enable_pin: !PF11
microsteps: 16
rotation_distance: 360
velocity: 600
accel: 6000
step_pulse_duration: 0.000002
homing_retract_dist: 0
endstop_pin: tmc2209_swingarm:virtual_endstop

[tmc2209 manual_stepper swingarm]
uart_pin: PC4
uart_address: 0
run_current: 0.65
hold_current: 0.35
sense_resistor: 0.110
stealthchop_threshold: 0        # spreadCycle for reliable stall detect
diag_pin: PA2
driver_SGTHRS: 40               # base sensitivity (tuned at runtime below)
interpolate: true


#####################################################################
# Helper: save/restore TMC params
#####################################################################

[gcode_macro _SWINGARM_TMC_SAVE]
variable_run: 0.65
variable_hold: 0.35
variable_sg: 40
variable_schop: 0
gcode:
  # keep current values in macro vars (edit defaults to match above)
  SET_GCODE_VARIABLE MACRO=_SWINGARM_TMC_SAVE VARIABLE=run  VALUE={printer.configfile.settings["tmc2209 manual_stepper swingarm"].run_current}
  SET_GCODE_VARIABLE MACRO=_SWINGARM_TMC_SAVE VARIABLE=hold VALUE={printer.configfile.settings["tmc2209 manual_stepper swingarm"].hold_current}
  SET_GCODE_VARIABLE MACRO=_SWINGARM_TMC_SAVE VARIABLE=sg   VALUE={printer.configfile.settings["tmc2209 manual_stepper swingarm"].driver_SGTHRS}
  SET_GCODE_VARIABLE MACRO=_SWINGARM_TMC_SAVE VARIABLE=schop VALUE={printer.configfile.settings["tmc2209 manual_stepper swingarm"].stealthchop_threshold}

[gcode_macro _SWINGARM_TMC_RESTORE]
gcode:
  SET_TMC_CURRENT STEPPER=swingarm CURRENT={printer["gcode_macro _SWINGARM_TMC_SAVE"].run} HOLDCURRENT={printer["gcode_macro _SWINGARM_TMC_SAVE"].hold}
  SET_TMC_FIELD   STEPPER=swingarm FIELD=SGTHRS VALUE={printer["gcode_macro _SWINGARM_TMC_SAVE"].sg}
  SET_TMC_FIELD   STEPPER=swingarm FIELD=TPWMTHRS VALUE=0
  # restore stealthchop threshold
  SET_TMC_FIELD   STEPPER=swingarm FIELD=TCOOLTHRS VALUE=0
  # Klipper exposes stealthchop_threshold via config; leaving it disabled for motion accuracy post-home is fine.
  # If you want stealthchop after homing, uncomment the next line to re-enable at very high speed threshold:
  # SET_TMC_FIELD STEPPER=swingarm FIELD=TPWMTHRS VALUE=1    ; approximate re-enable—depends on config/kinematics


#####################################################################
# Homing macro: gentle approach + backoff + zero
#####################################################################

[gcode_macro SWINGARM_HOME]
description: "Sensorless home swingarm with smooth stop (no buzzing)"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  RESPOND PREFIX="SWINGARM" MSG="Homing (sensorless): tuning driver..."

  # Save and set gentle homing params:
  _SWINGARM_TMC_SAVE
  # Slightly LOWER current can reduce chatter; too low = false stalls. Start ~0.55
  SET_TMC_CURRENT STEPPER=swingarm CURRENT=0.55 HOLDCURRENT=0.30
  # Make stall detection a bit LESS sensitive (higher value) to avoid chatter
  SET_TMC_FIELD   STEPPER=swingarm FIELD=SGTHRS VALUE=48

  # Slow approach to the hard stop
  RESPOND PREFIX="SWINGARM" MSG="Approaching stop..."
  MANUAL_STEPPER STEPPER=swingarm SET_POSITION=20            # preload away from zero so we always move toward stop
  MANUAL_STEPPER STEPPER=swingarm MOVE=-200 SPEED=120 ACCEL=1500 STOP_ON_ENDSTOP=1

  # Short dwell to let DIAG settle, then back off a hair to release pressure
  G4 P80
  MANUAL_STEPPER STEPPER=swingarm STOP=1
  MANUAL_STEPPER STEPPER=swingarm MOVE=3 RELATIVE=1 SPEED=100

  # Now declare this the zero, and return exactly to 0 smoothly
  MANUAL_STEPPER STEPPER=swingarm SET_POSITION=0
  MANUAL_STEPPER STEPPER=swingarm MOVE=0 SPEED=120

  # Restore your normal driver settings
  _SWINGARM_TMC_RESTORE

  RESPOND PREFIX="SWINGARM" MSG="Homed & zeroed cleanly."


#####################################################################
# Manual zero + moves (unchanged)
#####################################################################

[gcode_macro SWINGARM_ZERO]
description: "Manually set swingarm to 0° (closed)"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  G4 P200
  MANUAL_STEPPER STEPPER=swingarm SET_POSITION=0
  RESPOND PREFIX="SWINGARM" MSG="Manually zeroed."

[gcode_macro SWINGARM_OPEN]
description: "Move swingarm to 90° (open)"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  MANUAL_STEPPER STEPPER=swingarm MOVE=90 SPEED=2000

[gcode_macro SWINGARM_CLOSE]
description: "Move swingarm to 0° (closed)"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  MANUAL_STEPPER STEPPER=swingarm MOVE=0 SPEED=2000

[gcode_macro SWINGARM_TOGGLE]
description: "Toggle swingarm open/close"
variable_state: 0
gcode:
  {% if printer["gcode_macro SWINGARM_TOGGLE"].state|int == 0 %}
    SWINGARM_OPEN
    SET_GCODE_VARIABLE MACRO=SWINGARM_TOGGLE VARIABLE=state VALUE=1
  {% else %}
    SWINGARM_CLOSE
    SET_GCODE_VARIABLE MACRO=SWINGARM_TOGGLE VARIABLE=state VALUE=0
  {% endif %}
