#####################################################################
# Virtual Swingarm Axis (B) with Sensorless Homing
#####################################################################

# Add this near the top of your config
[virtual_sdcard]
path: ~/printer_data/gcodes

[printer]
kinematics: none                   # no physical XY motion needed for this device
max_velocity: 200
max_accel: 1000

#####################################################################
# Swingarm B Axis with Sensorless Homing
#####################################################################

[stepper_b]
step_pin: PE2
dir_pin: !PC5
enable_pin: !PF11
microsteps: 16
rotation_distance: 360             # degrees per revolution
position_endstop: 0                # home position is 0 degrees
position_min: 0
position_max: 140                  # avoid over-rotating past hard stop
homing_speed: 60                   # deg/sec
homing_retract_dist: 0             # no retract for sliding or rotating axis
homing_direction: -1               # home toward negative direction
endstop_pin: tmc2209_stepper_b:virtual_endstop   # sensorless endstop on DIAG pin

[tmc2209 stepper_b]
uart_pin: PC4
run_current: 0.10
hold_current: 0.08
sense_resistor: 0.110
interpolate: true
stealthchop_threshold: 0           # disable stealthChop for reliable stall detection
diag_pin: PG12                     # DIAG output to MCU
driver_SGTHRS: 5                   # StallGuard threshold (tune as needed)


#####################################################################
# Macros for Swingarm Motion
#####################################################################

[gcode_macro SWINGARM_HOME]
description: "Home swingarm using StallGuard sensorless homing"
gcode:
  RESPOND PREFIX="SWINGARM" MSG="Homing swingarm..."
  G28 B
  RESPOND PREFIX="SWINGARM" MSG="Sensorless homing complete. Swingarm at 0°."

[gcode_macro SWINGARM_OPEN]
description: "Swingarm to ~90°"
gcode:
  G1 B=98 F2000

[gcode_macro SWINGARM_CLOSE]
description: "Swingarm to 0°"
gcode:
  G1 B=0 F2000

[gcode_macro SWINGARM_TOGGLE]
description: "Toggle swingarm OPEN/CLOSE"
variable_state: 0
gcode:
  {% if printer["gcode_macro SWINGARM_TOGGLE"].state|int == 0 %}
    SWINGARM_OPEN
    SET_GCODE_VARIABLE MACRO=SWINGARM_TOGGLE VARIABLE=state VALUE=1
  {% else %}
    SWINGARM_CLOSE
    SET_GCODE_VARIABLE MACRO=SWINGARM_TOGGLE VARIABLE=state VALUE=0
  {% endif %}
