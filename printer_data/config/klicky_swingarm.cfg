#####################################################################
# Swingarm Manual Stepper (with Sensorless Homing via DIAG Pin)
#####################################################################

[manual_stepper swingarm]
step_pin: PE2
dir_pin: !PC5                          # invert if needed
enable_pin: !PF11
microsteps: 16
rotation_distance: 360                 # 1 full rotation = 360 degrees
velocity: 600                          # normal motion speed (deg/sec)
accel: 6000
step_pulse_duration: 0.000002          # 2 μs pulse width


[tmc2209 manual_stepper swingarm]
uart_pin: PC4
uart_address: 0
run_current: 0.65                      # normal running current
hold_current: 0.35
sense_resistor: 0.110
stealthchop_threshold: 0               # use spreadCycle for reliable stall detect
diag_pin: PA2                          # DIAG output from TMC to MCU pin
driver_SGTHRS: 40                      # base stall threshold; tuned during homing
interpolate: true


#####################################################################
# Helper: Save and Restore TMC Driver Parameters
#####################################################################

[gcode_macro _SWINGARM_TMC_SAVE]
# Hardcoded initial driver values to save/restore
variable_run: 0.65
variable_hold: 0.35
variable_sg: 40
gcode:
  RESPOND PREFIX="SWINGARM" MSG="Saving original TMC settings..."

[gcode_macro _SWINGARM_TMC_RESTORE]
gcode:
  SET_TMC_CURRENT STEPPER=swingarm CURRENT={printer["gcode_macro _SWINGARM_TMC_SAVE"].run} HOLDCURRENT={printer["gcode_macro _SWINGARM_TMC_SAVE"].hold}
  SET_TMC_FIELD STEPPER=swingarm FIELD=SGTHRS VALUE={printer["gcode_macro _SWINGARM_TMC_SAVE"].sg}
  RESPOND PREFIX="SWINGARM" MSG="Restored original TMC settings."


#####################################################################
# Sensorless Homing Macro (Poll DIAG Pin for Stall)
#####################################################################

[gcode_macro SWINGARM_HOME]
description: "Home swingarm using sensorless stall detection"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  RESPOND PREFIX="SWINGARM" MSG="Starting sensorless homing..."

  # Save current driver settings
  _SWINGARM_TMC_SAVE

  # Reduce current and adjust SGTHRS for gentle homing
  SET_TMC_CURRENT STEPPER=swingarm CURRENT=0.55 HOLDCURRENT=0.30
  SET_TMC_FIELD STEPPER=swingarm FIELD=SGTHRS VALUE=48

  # Start moving toward mechanical stop
  MANUAL_STEPPER STEPPER=swingarm SET_POSITION=20
  MANUAL_STEPPER STEPPER=swingarm MOVE=-200 SPEED=120 ACCEL=1500

  # Poll for stall via DIAG pin
  {% for i in range(100) %}
    {% if printer.tmc2209.swingarm.diag %}
      MANUAL_STEPPER STEPPER=swingarm STOP=1
      RESPOND PREFIX="SWINGARM" MSG="Stall detected (sensorless endstop)."
      break
    {% endif %}
    G4 P50  # Delay 50ms
  {% endfor %}

  # Back off slightly to relieve pressure
  MANUAL_STEPPER STEPPER=swingarm MOVE=3 RELATIVE=1 SPEED=100

  # Zero the position
  MANUAL_STEPPER STEPPER=swingarm SET_POSITION=0
  MANUAL_STEPPER STEPPER=swingarm MOVE=0 SPEED=120

  # Restore original driver settings
  _SWINGARM_TMC_RESTORE

  RESPOND PREFIX="SWINGARM" MSG="Homing complete. Position set to 0°."


#####################################################################
# Manual Zero and Position Control Macros
#####################################################################

[gcode_macro SWINGARM_ZERO]
description: "Manually set swingarm to 0° (closed)"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  G4 P200
  MANUAL_STEPPER STEPPER=swingarm SET_POSITION=0
  RESPOND PREFIX="SWINGARM" MSG="Manually zeroed."


[gcode_macro SWINGARM_OPEN]
description: "Move swingarm to 90° (open)"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  MANUAL_STEPPER STEPPER=swingarm MOVE=90 SPEED=2000


[gcode_macro SWINGARM_CLOSE]
description: "Move swingarm to 0° (closed)"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  MANUAL_STEPPER STEPPER=swingarm MOVE=0 SPEED=2000


[gcode_macro SWINGARM_TOGGLE]
description: "Toggle swingarm open/close"
variable_state: 0
gcode:
  {% if printer["gcode_macro SWINGARM_TOGGLE"].state|int == 0 %}
    SWINGARM_OPEN
    SET_GCODE_VARIABLE MACRO=SWINGARM_TOGGLE VARIABLE=state VALUE=1
  {% else %}
    SWINGARM_CLOSE
    SET_GCODE_VARIABLE MACRO=SWINGARM_TOGGLE VARIABLE=state VALUE=0
  {% endif %}
