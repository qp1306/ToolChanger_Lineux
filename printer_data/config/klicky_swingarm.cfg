#####################################################################
# Swingarm Manual Stepper (sensorless homing with DIAG detection)
#####################################################################

[manual_stepper swingarm]
step_pin: PE2
dir_pin: !PC5                   # flip to !PC5 if rotation is reversed
enable_pin: !PF11
microsteps: 16
rotation_distance: 360          # 1 full rotation = 360 degrees
velocity: 600                   # deg/sec max velocity
accel: 6000
step_pulse_duration: 0.000002   # 2 µs reliable pulse

[tmc2209 manual_stepper swingarm]
uart_pin: PC4
uart_address: 0
run_current: 0.10               # reduced current for light swingarm
hold_current: 0.10
sense_resistor: 0.110
stealthchop_threshold: 999999   # always use stealthChop (smooth moves)
interpolate: true
diag_pin: PG12                  # TMC StallGuard DIAG pin connected here
driver_SGTHRS: 0                # stall sensitivity (tune lower/higher if needed)


#####################################################################
# Swingarm Macros
#####################################################################

[gcode_macro SWINGARM_ZERO]
description: "Manually set swingarm to 0° (closed)"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  MANUAL_STEPPER STEPPER=swingarm SET_POSITION=0
  RESPOND PREFIX="SWINGARM" MSG="Zeroed at 0°"


[gcode_macro SWINGARM_HOME]
description: "Sensorless home swingarm using TMC stallGuard load monitoring"
gcode:
  RESPOND PREFIX="SWINGARM" MSG="Starting sensorless homing..."
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  MANUAL_STEPPER STEPPER=swingarm SET_POSITION=5     # offset position to allow backward movement

  # Begin movement toward the closed position
  MANUAL_STEPPER STEPPER=swingarm RUN=1 SPEED=80 DIR=-1

  # Poll TMC stallGuard load values to detect mechanical stall
  {% for i in range(200) %}
    {% set sg = printer["tmc2209 manual_stepper swingarm"].sg_result %}
    {% if sg <= 0 %}
      MANUAL_STEPPER STEPPER=swingarm STOP=1
      MANUAL_STEPPER STEPPER=swingarm SET_POSITION=0
      RESPOND PREFIX="SWINGARM" MSG="Stall detected via sg_result — homed and zeroed"
      break
    {% endif %}
    G4 P50  # wait 50ms before next poll
  {% endfor %}



[gcode_macro SWINGARM_OPEN]
description: "Move swingarm to ~90° (open)"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  MANUAL_STEPPER STEPPER=swingarm MOVE=98 SPEED=2000


[gcode_macro SWINGARM_CLOSE]
description: "Move swingarm to 0° (closed)"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  MANUAL_STEPPER STEPPER=swingarm MOVE=0 SPEED=2000


[gcode_macro SWINGARM_TOGGLE]
description: "Toggle swingarm open/close"
variable_state: 0
gcode:
  {% if printer["gcode_macro SWINGARM_TOGGLE"].state|int == 0 %}
    SWINGARM_OPEN
    SET_GCODE_VARIABLE MACRO=SWINGARM_TOGGLE VARIABLE=state VALUE=1
  {% else %}
    SWINGARM_CLOSE
    SET_GCODE_VARIABLE MACRO=SWINGARM_TOGGLE VARIABLE=state VALUE=0
  {% endif %}
