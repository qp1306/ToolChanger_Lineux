#####################################################################
# Swingarm Manual Stepper (no endstop, manual zeroing)
#####################################################################

[manual_stepper swingarm]
step_pin: PE2
dir_pin: !PC5               # flip to !PC5 if rotation is reversed
enable_pin: !PF11
microsteps: 16
rotation_distance: 360     # 1 full rotation = 360 degrees
velocity: 600              # deg/sec max velocity
accel: 6000
step_pulse_duration: 0.000002   # 2 µs reliable pulse

[tmc2209 manual_stepper swingarm]
uart_pin: PC4
uart_address: 0
run_current: 0.65          # adjust to ~70–80% of motor’s rated current
hold_current: 0.35         # reduce hold current to lower heat when idle
sense_resistor: 0.110
stealthchop_threshold: 999999   # always use stealthChop (smooth moves)
interpolate: true

stealthchop_threshold: 0          # disable stealthChop during homing
diag_pin: PG12                # connect DIAG pin from TMC to MCU pin
driver_SGTHRS: 0                 # adjust stall sensitivity (lower = more sensitive)

#####################################################################
# Swingarm Macros
#####################################################################

[gcode_macro SWINGARM_ZERO]
description: "Manually set swingarm to 0° (closed)"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  MANUAL_STEPPER STEPPER=swingarm SET_POSITION=0
  RESPOND PREFIX="SWINGARM" MSG="Zeroed at 0°"

[gcode_macro SWINGARM_OPEN]
description: "Move swingarm to 90° (open)"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  MANUAL_STEPPER STEPPER=swingarm MOVE=110 SPEED=2000

[gcode_macro SWINGARM_CLOSE]
description: "Move swingarm to 0° (closed)"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  MANUAL_STEPPER STEPPER=swingarm MOVE=0 SPEED=2000


#####################################################################
# Optional: Quick toggle between open/close
#####################################################################

[gcode_macro SWINGARM_TOGGLE]
description: "Toggle swingarm open/close"
variable_state: 0
gcode:
  {% if printer["gcode_macro SWINGARM_TOGGLE"].state|int == 0 %}
    SWINGARM_OPEN
    SET_GCODE_VARIABLE MACRO=SWINGARM_TOGGLE VARIABLE=state VALUE=1
  {% else %}
    SWINGARM_CLOSE
    SET_GCODE_VARIABLE MACRO=SWINGARM_TOGGLE VARIABLE=state VALUE=0
  {% endif %}




[gcode_macro SWINGARM_HOME]
description: "Home swingarm to mechanical stop using sensorless homing"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  RESPOND PREFIX="SWINGARM" MSG="Starting sensorless homing..."
  MANUAL_STEPPER STEPPER=swingarm MOVE=-120 SPEED=200  # move backward toward closed stop
  G4 P200  # wait for mechanical stall to trigger
  MANUAL_STEPPER STEPPER=swingarm STOP=1  # stop motion on stall
  MANUAL_STEPPER STEPPER=swingarm SET_POSITION=0
  RESPOND PREFIX="SWINGARM" MSG="Homed and zeroed."
