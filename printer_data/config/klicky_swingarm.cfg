#####################################################################
# Swingarm Manual Stepper (with Sensorless Homing)
#####################################################################

[manual_stepper swingarm]
step_pin: PE2
dir_pin: !PC5                           # invert if needed
enable_pin: !PF11
microsteps: 16
rotation_distance: 360                  # 1 full rotation = 360 degrees
velocity: 600                           # normal motion speed (deg/sec)
accel: 6000
step_pulse_duration: 0.000002           # 2 µs pulse width


[tmc2209 manual_stepper swingarm]
uart_pin: PC4
uart_address: 0
run_current: 0.65                       # normal running current
hold_current: 0.35
sense_resistor: 0.110
stealthchop_threshold: 0                # disable stealthChop during homing
diag_pin: PA2                           # DIAG output from TMC to MCU pin
driver_SGTHRS: 40                       # base stall threshold; tuned during homing
interpolate: true


#####################################################################
# Helper: Save and Restore TMC Driver Parameters
#####################################################################

[gcode_macro _SWINGARM_TMC_SAVE]
variable_run: 0.65
variable_hold: 0.35
variable_sg: 40
gcode:
  SET_GCODE_VARIABLE MACRO=_SWINGARM_TMC_SAVE VARIABLE=run  VALUE={printer.configfile.settings["tmc2209 manual_stepper swingarm"].run_current}
  SET_GCODE_VARIABLE MACRO=_SWINGARM_TMC_SAVE VARIABLE=hold VALUE={printer.configfile.settings["tmc2209 manual_stepper swingarm"].hold_current}
  SET_GCODE_VARIABLE MACRO=_SWINGARM_TMC_SAVE VARIABLE=sg   VALUE={printer.configfile.settings["tmc2209 manual_stepper swingarm"].driver_SGTHRS}


[gcode_macro _SWINGARM_TMC_RESTORE]
gcode:
  SET_TMC_CURRENT STEPPER=swingarm CURRENT={printer["gcode_macro _SWINGARM_TMC_SAVE"].run} HOLDCURRENT={printer["gcode_macro _SWINGARM_TMC_SAVE"].hold}
  SET_TMC_FIELD STEPPER=swingarm FIELD=SGTHRS VALUE={printer["gcode_macro _SWINGARM_TMC_SAVE"].sg}


#####################################################################
# Smooth Sensorless Homing (reduced buzzing at hard stop)
#####################################################################

[gcode_macro SWINGARM_HOME]
description: "Home swingarm using sensorless stall detection"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  RESPOND PREFIX="SWINGARM" MSG="Starting sensorless homing..."

  # Save current TMC driver config
  _SWINGARM_TMC_SAVE

  # Reduce current and adjust SGTHRS for gentle homing
  SET_TMC_CURRENT STEPPER=swingarm CURRENT=0.55 HOLDCURRENT=0.30
  SET_TMC_FIELD STEPPER=swingarm FIELD=SGTHRS VALUE=48

  # Move toward the hard stop until stall is detected
  MANUAL_STEPPER STEPPER=swingarm SET_POSITION=20
  MANUAL_STEPPER STEPPER=swingarm MOVE=-200 SPEED=120 ACCEL=1500 STOP_ON_ENDSTOP=1

  # Pause briefly, then back off a few degrees to release pressure
  G4 P80
  MANUAL_STEPPER STEPPER=swingarm STOP=1
  MANUAL_STEPPER STEPPER=swingarm MOVE=3 RELATIVE=1 SPEED=100

  # Set zero position at the hard stop
  MANUAL_STEPPER STEPPER=swingarm SET_POSITION=0
  MANUAL_STEPPER STEPPER=swingarm MOVE=0 SPEED=120

  # Restore normal TMC driver settings
  _SWINGARM_TMC_RESTORE

  RESPOND PREFIX="SWINGARM" MSG="Homing complete. Position set to 0°."


#####################################################################
# Manual Zero and Position Control Macros
#####################################################################

[gcode_macro SWINGARM_ZERO]
description: "Manually set swingarm to 0° (closed)"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  G4 P200
  MANUAL_STEPPER STEPPER=swingarm SET_POSITION=0
  RESPOND PREFIX="SWINGARM" MSG="Manually zeroed."


[gcode_macro SWINGARM_OPEN]
description: "Move swingarm to 90° (open)"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  MANUAL_STEPPER STEPPER=swingarm MOVE=90 SPEED=2000


[gcode_macro SWINGARM_CLOSE]
description: "Move swingarm to 0° (closed)"
gcode:
  MANUAL_STEPPER STEPPER=swingarm ENABLE=1
  MANUAL_STEPPER STEPPER=swingarm MOVE=0 SPEED=2000


[gcode_macro SWINGARM_TOGGLE]
description: "Toggle swingarm open/close"
variable_state: 0
gcode:
  {% if printer["gcode_macro SWINGARM_TOGGLE"].state|int == 0 %}
    SWINGARM_OPEN
    SET_GCODE_VARIABLE MACRO=SWINGARM_TOGGLE VARIABLE=state VALUE=1
  {% else %}
    SWINGARM_CLOSE
    SET_GCODE_VARIABLE MACRO=SWINGARM_TOGGLE VARIABLE=state VALUE=0
  {% endif %}
