[gcode_button nudge_sensor_pin]
pin: ^PG12
press_gcode:
release_gcode:

[gcode_macro Z_NUDGE_offset]
variable_num_tools: 2  # <<< adjust this to your number of tools
variable_offsets: ""

gcode:
  G28 ; Home all axes
  { action_respond_info("Starting Z nudge offset workflow...") }

  # Save current X/Y/Z as probe position
  SET_GCODE_VARIABLE MACRO=Z_NUDGE_offset VARIABLE=probe_x VALUE={printer.toolhead.position.x}
  SET_GCODE_VARIABLE MACRO=Z_NUDGE_offset VARIABLE=probe_y VALUE={printer.toolhead.position.y}

  # Tool 0 reference measurement
  T0
  G90
  G0 X{printer["gcode_macro Z_NUDGE_offset"].probe_x} Y{printer["gcode_macro Z_NUDGE_offset"].probe_y} F6000
  G91
  _probe_z_contact
  SET_GCODE_VARIABLE MACRO=Z_NUDGE_offset VARIABLE=z_ref VALUE={printer.toolhead.position.z}
  { action_respond_info("T0 Z: %.3f" % printer.toolhead.position.z) }

  # Loop through remaining tools
  {% for i in range(1, printer["gcode_macro Z_NUDGE_offset"].num_tools|int) %}
    T{i}
    G90
    G0 X{printer["gcode_macro Z_NUDGE_offset"].probe_x} Y{printer["gcode_macro Z_NUDGE_offset"].probe_y} F6000
    G91
    _probe_z_contact
    {% set z_current = printer.toolhead.position.z %}
    {% set z_offset = z_current - printer["gcode_macro Z_NUDGE_offset"].z_ref %}
    SET_GCODE_VARIABLE MACRO=Z_NUDGE_offset VARIABLE=offsets VALUE={printer["gcode_macro Z_NUDGE_offset"].offsets + "tool_offset_z_t%d: %.3f\n" % (i, z_offset)}
    { action_respond_info("T%d Z: %.3f Offset: %.3f" % (i, z_current, z_offset)) }
  {% endfor %}

  { action_respond_info("\n[variables]\ntool_offset_z_t0: %.3f\n%s" % (printer["gcode_macro Z_NUDGE_offset"].z_ref, printer["gcode_macro Z_NUDGE_offset"].offsets)) }

[gcode_macro _probe_z_contact]
gcode:
  {% set step = 0.02 %}
  {% set speed = 60 %}
  {% for i in range(2000) %}
    {% if printer["gcode_button nudge_sensor_pin"].state == "RELEASED" %}
      G0 Z-{step} F{speed}
      M400
    {% else %}
      BREAK
    {% endif %}
  {% endfor %}
