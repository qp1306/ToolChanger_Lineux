# BTC Nudge Z-Only Multi-Tool Calibration â€” Final Clean Version

[gcode_button nudge_sensor_pin]
pin: ^PG12
press_gcode:
release_gcode:

[gcode_macro _btc_Variables]
variable_numoftool: [0,1,2]
gcode:

[gcode_macro _nudge_variables]
variable_nudge_resolution: 0.05
variable_nudge_travel_speed: 100
variable_nudge_move_delay: 2
variable_nudge_last_value: -128
variable_nudge_value_z: -128
variable_nudge_cal_z: -128
variable_sensor_triggered: 0
gcode:

[gcode_macro NUDGE_FIND_TOOL_OFFSETS]
gcode:
  G28
  {% set numoftool = printer["gcode_macro _btc_Variables"].numoftool %}
  {% for tool in numoftool %}
    M104 S150 T{tool}
  {% endfor %}
  {% for tool in numoftool %}
    T{tool}
    M109 S150 T{tool}
    _TOOL_LOCATE_SENSOR TOOL={tool}
    M104 S0 T{tool}
  {% endfor %}
  _print_z_results

[gcode_macro _TOOL_LOCATE_SENSOR]
gcode:
  {% set tool = params.TOOL|int %}
  G91
  _locate_sensor
  G90
  {% if tool == 0 %}
    SET_GCODE_VARIABLE MACRO=_nudge_variables VARIABLE=nudge_value_z VALUE={printer["gcode_macro _nudge_variables"].nudge_last_value|float}
    { action_respond_info("Tool 0 contact at Z: %.3f mm" % printer["gcode_macro _nudge_variables"].nudge_value_z|float) }
  {% else %}
    {% set zref = printer["gcode_macro _nudge_variables"].nudge_value_z|float %}
    {% set zpos = printer["gcode_macro _nudge_variables"].nudge_last_value|float %}
    {% set zoffset = zpos - zref %}
    { action_respond_info("Tool {tool} contact at Z: %.3f mm (Offset from Tool 0: %.3f mm)" % (zpos, zoffset)) }
  {% endif %}

[gcode_macro _locate_sensor]
gcode:
  SET_GCODE_VARIABLE MACRO=_nudge_variables VARIABLE=sensor_triggered VALUE=0
  {% set nudge_travel_speed = printer["gcode_macro _nudge_variables"].nudge_travel_speed * 60 %}
  {% for moves in range(500) %}
    {% if printer["gcode_macro _nudge_variables"].sensor_triggered|int == 0 %}
      _do_nudge_move
      G4 P{printer["gcode_macro _nudge_variables"].nudge_move_delay}
    {% endif %}
  {% endfor %}
  G0 Z3 F{nudge_travel_speed}
  M400
  SET_GCODE_VARIABLE MACRO=_nudge_variables VARIABLE=nudge_cal_z VALUE={printer["gcode_macro _nudge_variables"].nudge_last_value|float}

[gcode_macro _do_nudge_move]
gcode:
  {% set nudge_state = printer['gcode_button nudge_sensor_pin'].state %}
  {% if nudge_state == "RELEASED" %}
    {% set nudge_speed = printer["gcode_macro _nudge_variables"].nudge_travel_speed * 60 %}
    {% set nudge_resolution = printer["gcode_macro _nudge_variables"].nudge_resolution %}
    G0 Z-{nudge_resolution} F{nudge_speed}
    M400
  {% else %}
    SET_GCODE_VARIABLE MACRO=_nudge_variables VARIABLE=nudge_last_value VALUE={printer.toolhead.position.z}
    SET_GCODE_VARIABLE MACRO=_nudge_variables VARIABLE=sensor_triggered VALUE=1
  {% endif %}

[gcode_macro _print_z_results]
gcode:
  { action_respond_info("BTC_Nudge: Multi-tool Z nudge sequence complete.") }
